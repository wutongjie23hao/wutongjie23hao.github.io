---
layout: post
title: "k8s学习-服务质量等级(Qos)"
subtitle: "给 Pod 配置服务质量等级"
author: Xiaolei.liang
header-img: "img/post-bg-unix-linux.jpg"
catalog: true
tags:
  - k8s学习
---
## 前言
开始之前需要有一个k8s集群，使用一下方式:
* minikube本地安装
* [Katacoda](https://www.katacoda.com/courses/kubernetes/playground)
* [Play with Kubernetes](http://labs.play-with-k8s.com/)

## OsS等级
当 Kubernetes 创建一个 Pod 时，它就会给这个 Pod 分配一个 QoS 等级：
* Guaranteed
* Burstable
* BestEffort

## 创建namespace
``kubectl create namespace qos-example``

## 创建一个 Pod 并分配 QoS 等级为 Guaranteed
Pod 分配 QoS 等级为 Guaranteed:
* 容器中必须都要有内存的limit和req，而且limit值和req值相同
* 容器中必须都要有cpu的limit和req，而且limit值和req值相同

以下是一个创建pod的配置文件:``qos-pod.yaml``，其中内存200MB，cpu 700 millicpu:
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: qos-demo
  namespace: qos-example
spec:
  containers:
  - name: qos-demo-ctr
    image: nginx
    resources:
      limits:
        memory: "200Mi"
        cpu: "700m"
      requests:
        memory: "200Mi"
        cpu: "700m"
```

创建pod：``kubectl create -f qos-pod.yaml``

查看pod的详细信息：``kubectl get pod qos-demo -o qos-example -o yaml | grep qosClass``，输出:``qosClass: Guaranteed``

>> **注意:** 如果一个容器配置了内存限制，但是没有配置内存申请，那 Kubernetes 会自动给容器分配一个符合内存限制的请求。 类似的，如果容器有 CPU 限制，但是没有 CPU 申请，Kubernetes 也会自动分配一个符合限制的请求。

删除pod: ``kubectl delete -f qos-pod.yaml``

## 创建一个 Pod 并分配 QoS 等级为 Burstable
当出现下面的情况时，则是一个 Pod 被分配了 QoS 等级为 Burstable :
* Pod 里至少有一个容器有内存或者 CPU 请求
* 该 Pod 不满足 QoS 等级 Guaranteed 的要求

这是 Pod 的配置文件，里面有一个容器。这个容器配置了200MB的内存限制和100MB的内存申请。
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: qos-demo-2
  namespace: qos-example
spec:
  containers:
  - name: qos-demo-2-ctr
    image: nginx
    resources:
      limits:
        memory: "200Mi"
      requests:
        memory: "100Mi"
```

## 创建一个 Pod 并分配 QoS 等级为 BestEffort
要给一个 Pod 配置 BestEffort 的 QoS 等级, Pod 里的容器必须没有任何内存或者 CPU　的限制或请求。

下面是一个　Pod　的配置文件，包含一个容器。这个容器没有内存或者 CPU 的限制或者请求：
```
apiVersion: v1
kind: Pod
metadata:
  name: qos-demo-3
  namespace: qos-example
spec:
  containers:
  - name: qos-demo-3-ctr
    image: nginx
```

## 创建一个拥有两个容器的 Pod
这是一个含有两个容器的 Pod 的配置文件，其中一个容器指定了内存申请为 200MB ，另外一个没有任何申请或限制。
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: qos-demo-4
  namespace: qos-example
spec:
  containers:

  - name: qos-demo-4-ctr-1
    image: nginx
    resources:
      requests:
        memory: "200Mi"

  - name: qos-demo-4-ctr-2
    image: redis
```

注意到这个 Pod 满足了 QoS 等级 Burstable 的要求. 就是说，它不满足 Guaranteed 的要求，而且其中一个容器有内存请求。

## 总结
当resources只写了limits的时候，会给自动加上requests；如果只写了requests的话，则limits不会增加。其中，requests用作调度，limits用作资源限制。

## 参考
* [https://k8smeetup.github.io/docs/tasks/configure-pod-container/quality-service-pod/](https://k8smeetup.github.io/docs/tasks/configure-pod-container/quality-service-pod/)
* [https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/](https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/)